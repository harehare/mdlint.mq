#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
mqlint - Markdown linter using mdlint.mq

Usage:
  mqlint [OPTIONS] [FILE...]

Options:
  -h, --help              Show this help message
  -v, --version           Show version
  -c, --config FILE       Use custom config file (default: .lintrc.toml)
  -q, --quiet             Quiet mode (suppress info messages)
  -j, --json              Output results in JSON format

Arguments:
  FILE                    Markdown file(s) to lint (default: all .md files)

Examples:
  mqlint README.md        Lint README.md
  mqlint *.md             Lint all .md files
  mqlint                  Lint all .md files in current directory
  mqlint -c custom.toml   Use custom config file
  mqlint -j README.md     Output in JSON format

EOF
}

show_version() {
    echo "mqlint version $VERSION"
}

# Default values
CONFIG_FILE=".lintrc.toml"
QUIET=false
JSON_OUTPUT=false
FILES=()
FILE_ARGS=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -c|--config)
            CONFIG_FILE="$2"
            shift 2
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        -j|--json)
            JSON_OUTPUT=true
            shift
            ;;
        -*)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
        *)
            FILE_ARGS+=("$1")
            shift
            ;;
    esac
done

# Check if fd is available
if ! command -v fd >/dev/null 2>&1; then
    echo -e "${RED}Error: 'fd' command not found. Please install 'fd' to use this script.${NC}" >&2
    exit 1
fi

# Process file arguments
if [ ${#FILE_ARGS[@]} -gt 0 ]; then
    for arg in "${FILE_ARGS[@]}"; do
        # Check if argument contains glob patterns
        if [[ "$arg" == *"*"* ]]; then
            # Use fd to expand glob pattern
            mapfile -t -O ${#FILES[@]} FILES < <(fd --type f --extension md --glob "$arg")
        else
            # Not a glob pattern, add as-is
            FILES+=("$arg")
        fi
    done

    if [ ${#FILES[@]} -eq 0 ]; then
        echo -e "${YELLOW}No matching files found${NC}"
        exit 0
    fi
else
    # If no files specified, use fd to find all .md files
    mapfile -t FILES < <(fd --type f --extension md --strip-cwd-prefix)

    if [ ${#FILES[@]} -eq 0 ]; then
        echo -e "${YELLOW}No Markdown files found in current directory${NC}"
        exit 0
    fi
fi

echo

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    if [ "$CONFIG_FILE" != ".lintrc.toml" ]; then
        echo -e "${RED}Error: Config file '$CONFIG_FILE' not found${NC}"
        exit 1
    fi
    # Use default config if .lintrc.toml doesn't exist
    CONFIG_LOAD="mdlint::default_config()"
else
    CONFIG_LOAD="mdlint::load_config(\"$CONFIG_FILE\") | merge_config()"
fi

# Process each file with a separate mq execution
HAS_ERROR=false

if [ "$JSON_OUTPUT" = true ]; then
    # JSON output
    MQ_SCRIPT="import \"mdlint\" | let config = $CONFIG_LOAD | mdlint::lint_all_with_config(config) | mdlint::generate_json_report()"

    if OUTPUT=$(mq -S 's"\n${__FILE__}\n"' -I raw -F text "$MQ_SCRIPT" "${FILES[@]}" 2>&1); then
        echo "$OUTPUT"
    else
        echo -e "${RED}Error running linter on $file:${NC}" >&2
        echo "$OUTPUT" >&2
        HAS_ERROR=true
    fi
else
    MQ_SCRIPT="import \"mdlint\" | let config = $CONFIG_LOAD | mdlint::lint_all_with_config(config) | mdlint::generate_report()"

    if ! mq -S 's"\n${__FILE__}\n"' -I raw "$MQ_SCRIPT" "${FILES[@]}" 2>&1; then
        echo -e "${RED}Error running linter on $file${NC}" >&2
        HAS_ERROR=true
    fi
fi

if [ "$JSON_OUTPUT" = false ] && [ "$QUIET" = false ]; then
    echo -e "\n${GREEN}Linted ${#FILES[@]} file(s)${NC}"
fi

if [ "$HAS_ERROR" = true ]; then
    exit 1
fi

exit 0
