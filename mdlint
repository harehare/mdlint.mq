#!/usr/bin/env bash
# mqlint - Markdown linter using mdlint.mq
#
# Usage:
#   mqlint [file.md]              Lint a specific file
#   mqlint                        Lint all .md files in current directory
#   mqlint -h, --help             Show help message

set -euo pipefail

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
mqlint - Markdown linter using mdlint.mq

Usage:
  mqlint [OPTIONS] [FILE...]

Options:
  -h, --help              Show this help message
  -v, --version           Show version
  -c, --config FILE       Use custom config file (default: .lintrc.toml)
  -q, --quiet             Quiet mode (suppress info messages)
  -j, --json              Output results in JSON format

Arguments:
  FILE                    Markdown file(s) to lint (default: all .md files)

Examples:
  mqlint README.md        Lint README.md
  mqlint *.md             Lint all .md files
  mqlint                  Lint all .md files in current directory
  mqlint -c custom.toml   Use custom config file
  mqlint -j README.md     Output in JSON format

EOF
}

show_version() {
    echo "mqlint version $VERSION"
}

# Default values
CONFIG_FILE=".lintrc.toml"
QUIET=false
JSON_OUTPUT=false
FILES=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -c|--config)
            CONFIG_FILE="$2"
            shift 2
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        -j|--json)
            JSON_OUTPUT=true
            shift
            ;;
        -*)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
        *)
            FILES+=("$1")
            shift
            ;;
    esac
done

# If no files specified, find all .md files
if [ ${#FILES[@]} -eq 0 ]; then
    mapfile -t FILES < <(find . -maxdepth 1 -name "*.md" -type f)
    if [ ${#FILES[@]} -eq 0 ]; then
        echo -e "${YELLOW}No Markdown files found in current directory${NC}"
        exit 0
    fi
fi

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    if [ "$CONFIG_FILE" != ".lintrc.toml" ]; then
        echo -e "${RED}Error: Config file '$CONFIG_FILE' not found${NC}"
        exit 1
    fi
    # Use default config if .lintrc.toml doesn't exist
    CONFIG_LOAD="default_config()"
else
    CONFIG_LOAD="load_config(\"$CONFIG_FILE\") | merge_config()"
fi

# Validate files and build JSON array of file paths
VALID_FILES=()
for file in "${FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo -e "${RED}Error: File '$file' not found${NC}" >&2
        continue
    fi
    VALID_FILES+=("$file")
done

if [ ${#VALID_FILES[@]} -eq 0 ]; then
    echo -e "${RED}No valid files to lint${NC}" >&2
    exit 1
fi

# Process each file with a separate mq execution
HAS_ERROR=false

for file in "${VALID_FILES[@]}"; do
    # Escape file path for JSON (escape backslashes and quotes)
    ESCAPED_FILE=$(printf '%s' "$file" | sed 's/\\/\\\\/g; s/"/\\"/g')

    if [ "$JSON_OUTPUT" = true ]; then
        # JSON output
        MQ_SCRIPT="include \"mdlint\" | let config = $CONFIG_LOAD | print(\"\n\" + \"$ESCAPED_FILE\" + \"\n\") | read_file(\"$ESCAPED_FILE\") | lint_all_with_config(config) | generate_json_report() | print()"

        if OUTPUT=$(mq -I raw -F text "$MQ_SCRIPT" 2>&1); then
            echo "$OUTPUT"
        else
            echo -e "${RED}Error running linter on $file:${NC}" >&2
            echo "$OUTPUT" >&2
            HAS_ERROR=true
        fi
    else
        # Text output
        MQ_SCRIPT="include \"mdlint\" | let config = $CONFIG_LOAD | print(\"\n\" + \"$ESCAPED_FILE\" + \"\n\") | read_file(\"$ESCAPED_FILE\") | lint_all_with_config(config) | generate_report() | print()"

        if ! mq -I raw "$MQ_SCRIPT" 2>&1; then
            echo -e "${RED}Error running linter on $file${NC}" >&2
            HAS_ERROR=true
        fi
    fi
done

if [ "$JSON_OUTPUT" = false ] && [ "$QUIET" = false ]; then
    echo -e "\n${GREEN}Linted ${#VALID_FILES[@]} file(s)${NC}"
fi

if [ "$HAS_ERROR" = true ]; then
    exit 1
fi

exit 0
