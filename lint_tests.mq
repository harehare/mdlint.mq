include "lint"
| include "test"

# Test data for MD001 - Heading levels should only increment by one level at a time
def test_md001_valid_heading_progression():
  let content = to_markdown("# H1\n## H2\n### H3\n")
  | let result = md001(content)
  | assert_eq(len(result), 0)
end

def test_md001_invalid_heading_skip():
  let content = to_markdown("# H1\n### H3 (skipped H2)\n")
  | let result = md001(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD001")
  | assert_eq(result[0]["severity"], "error")
end

# Test data for MD002 - First header should be a top level header
def test_md002_valid_first_header():
  let config = default_config()
  | let content = to_markdown("# First Header\n## Second Header\n")
  | let result = md002(content, config)
  | assert_eq(len(result), 0)
end

def test_md002_invalid_first_header():
  let config = default_config()
  | let content = to_markdown("## Not H1\n### Another Header\n")
  | let result = md002(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD002")
  | assert_eq(result[0]["severity"], "error")
end

# Test data for MD003 - Heading style consistency
def test_md003_consistent_atx_style():
  let config = default_config()
  | let raw_content = "# Header 1\n## Header 2\n### Header 3\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 0)
end

def test_md003_inconsistent_styles():
  let config = default_config()
  | let raw_content = "# Header 1\n## Header 2\n### Header 3 ###\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD003")
  | assert_eq(result[0]["severity"], "error")
end

def test_md003_enforce_atx_style():
  let config = {
    lint: {
      rules: ["MD003"],
      md003: {style: "atx"}
    }
  }
  | let raw_content = "# Header 1\n## Header 2 ##\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD003")
  | assert_eq(result[0]["details"]["expected"], "atx")
  | assert_eq(result[0]["details"]["found"], "atx_closed")
end

def test_md003_enforce_atx_closed_style():
  let config = {
    lint: {
      rules: ["MD003"],
      md003: {style: "atx_closed"}
    }
  }
  | let raw_content = "# Header 1 #\n## Header 2 ##\n### Header 3\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["details"]["expected"], "atx_closed")
  | assert_eq(result[0]["details"]["found"], "atx")
end

def test_md003_consistent_setext_style():
  let config = default_config()
  | let raw_content = "Header 1\n========\n\nHeader 2\n--------\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 0)
end

def test_md003_enforce_setext_style():
  let config = {
    lint: {
      rules: ["MD003"],
      md003: {style: "setext"}
    }
  }
  | let raw_content = "Header 1\n========\n\n## Header 2\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD003")
  | assert_eq(result[0]["details"]["expected"], "setext")
  | assert_eq(result[0]["details"]["found"], "atx")
end

def test_md003_mixed_atx_and_setext():
  let config = default_config()
  | let raw_content = "# Header 1\n\nHeader 2\n--------\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD003")
  | assert_eq(result[0]["details"]["expected"], "atx")
  | assert_eq(result[0]["details"]["found"], "setext")
end

def test_md003_setext_h1_only():
  let config = default_config()
  | let raw_content = "Header 1\n========\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 0)
end

def test_md003_setext_h2_only():
  let config = default_config()
  | let raw_content = "Header 2\n--------\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md003(content, lines, config)
  | assert_eq(len(result), 0)
end

# Test data for MD004 - Unordered list style
def test_md004_consistent_dash_style():
  let config = default_config()
  | let raw_content = "- Item 1\n- Item 2\n- Item 3\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 0)
end

def test_md004_consistent_asterisk_style():
  let config = default_config()
  | let raw_content = "* Item 1\n* Item 2\n* Item 3\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 0)
end

def test_md004_consistent_plus_style():
  let config = default_config()
  | let raw_content = "+ Item 1\n+ Item 2\n+ Item 3\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 0)
end

def test_md004_inconsistent_styles():
  let config = default_config()
  | let raw_content = "- Item 1\n* Item 2\n+ Item 3\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 2)
  | assert_eq(result[0]["rule"], "MD004")
  | assert_eq(result[0]["severity"], "error")
end

def test_md004_enforce_dash_style():
  let config = {
    lint: {
      rules: ["MD004"],
      md004: {style: "dash"}
    }
  }
  | let raw_content = "- Item 1\n* Item 2\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD004")
  | assert_eq(result[0]["details"]["expected"], "dash")
  | assert_eq(result[0]["details"]["found"], "asterisk")
end

def test_md004_enforce_asterisk_style():
  let config = {
    lint: {
      rules: ["MD004"],
      md004: {style: "asterisk"}
    }
  }
  | let raw_content = "* Item 1\n- Item 2\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["details"]["expected"], "asterisk")
  | assert_eq(result[0]["details"]["found"], "dash")
end

def test_md004_enforce_plus_style():
  let config = {
    lint: {
      rules: ["MD004"],
      md004: {style: "plus"}
    }
  }
  | let raw_content = "+ Item 1\n- Item 2\n"
  | let content = to_markdown(raw_content)
  | let lines = split(raw_content, "\n")
  | let result = md004(content, lines, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["details"]["expected"], "plus")
  | assert_eq(result[0]["details"]["found"], "dash")
end

# Test data for MD024 - Multiple headers with the same content
def test_md024_no_duplicate_headers():
  let config = default_config()
  | let content = to_markdown("# Header 1\n## Header 2\n### Header 3\n")
  | let result = md024(content, config)
  | assert_eq(len(result), 0)
end

def test_md024_duplicate_headers():
  let config = default_config()
  | let content = to_markdown("# Test\n## Test\n")
  | let result = md024(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD024")
  | assert_eq(result[0]["severity"], "warning")
end

# Test data for MD025 - Multiple top level headers
def test_md025_single_h1():
  let config = default_config()
  | let content = to_markdown("# Only One H1\n## H2\n### H3\n")
  | let result = md025(content, config)
  | assert_eq(len(result), 0)
end

def test_md025_multiple_h1():
  let config = default_config()
  | let content = to_markdown("# First H1\n## H2\n# Second H1\n")
  | let result = md025(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD025")
  | assert_eq(result[0]["severity"], "error")
end

# Test data for MD026 - Trailing punctuation in header
def test_md026_no_trailing_punctuation():
  let config = default_config()
  | let content = to_markdown("# Clean Header\n## Another Clean Header\n")
  | let result = md026(content, config)
  | assert_eq(len(result), 0)
end

def test_md026_trailing_period():
  let config = default_config()
  | let content = to_markdown("# Header with period.\n")
  | let result = md026(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD026")
  | assert_eq(result[0]["severity"], "warning")
end

def test_md026_trailing_question():
  let config = default_config()
  | let content = to_markdown("# Header with question?\n")
  | let result = md026(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD026")
end

# Test data for MD033 - Inline HTML
def test_md033_no_html():
  let config = default_config()
  | let content = to_markdown("# Header\n\nJust plain text.\n")
  | let result = md033(content, config)
  | assert_eq(len(result), 0)
end

def test_md033_inline_html():
  let config = default_config()
  | let content = to_markdown("# Header\n\n<div>Some HTML</div>\n")
  | let result = md033(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD033")
  | assert_eq(result[0]["severity"], "warning")
end

# Test data for MD040 - Fenced code blocks should have a language
def test_md040_code_with_language():
  let config = default_config()
  | let content = to_markdown("# Header\n\n```javascript\nconsole.log('test');\n```\n")
  | let result = md040(content, config)
  | assert_eq(len(result), 0)
end

def test_md040_code_without_language():
  let config = default_config()
  | let content = to_markdown("# Header\n\n```\ncode without language\n```\n")
  | let result = md040(content, config)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD040")
  | assert_eq(result[0]["severity"], "warning")
end

# Test helper functions
def test_format_issue():
  let issue = {
    rule: "MD001",
    name: "heading-increment",
    severity: "error",
    message: "Test message",
    line: 5
  }
  | let formatted = format_issue(issue)
  | assert_eq(contains(formatted, "MD001"), true)
  | assert_eq(contains(formatted, "heading-increment"), true)
  | assert_eq(contains(formatted, "Test message"), true)
end

def test_count_by_severity():
  let issues = [
    {severity: "error"},
    {severity: "error"},
    {severity: "warning"},
    {severity: "info"}
  ]
  | let counts = count_by_severity(issues)
  | assert_eq(counts["errors"], 2)
  | assert_eq(counts["warnings"], 1)
  | assert_eq(counts["info"], 1)
  | assert_eq(counts["total"], 4)
end

# Integration test with lint_all
def test_lint_all_clean_document():
  let content = "# Title\n\n## Section\n\nContent here.\n"
  | let result = lint_all(content)
  | assert_eq(result["summary"]["errors"], 0)
end

def test_lint_all_with_issues():
  let content = "## Not H1\n\n### Skipped Level\n\n# Duplicate\n\n# Duplicate\n"
  | let result = lint_all(content)
  | let total = result["summary"]["total"]
  | assert_eq(total > 0, true)
end

# Test generate_report function
def test_generate_report_no_issues():
  let lint_result = {
    issues: [],
    summary: {errors: 0, warnings: 0, info: 0, total: 0}
  }
  | let report = generate_report(lint_result)
  | assert_eq(contains(report, "No issues found"), true)
end

def test_generate_report_with_issues():
  let issue = {
    rule: "MD001",
    name: "heading-increment",
    severity: "error",
    message: "Test issue",
    line: 1
  }
  | let lint_result = {
    issues: [issue],
    summary: {errors: 1, warnings: 0, info: 0, total: 1}
  }
  | let report = generate_report(lint_result)
  | assert_eq(contains(report, "Markdown Lint Report"), true)
  | assert_eq(contains(report, "Found 1 issues"), true)
end

# Test configuration functions
def test_default_config():
  let config = default_config()
  | assert_eq(contains(config["lint"]["rules"], "MD001"), true)
  | assert_eq(contains(config["lint"]["rules"], "MD002"), true)
  | assert_eq(config["lint"]["md002"]["level"], 1)
end

def test_is_rule_enabled():
  let config = default_config()
  | assert_eq(is_rule_enabled(config, "MD001"), true)
  | assert_eq(is_rule_enabled(config, "MD002"), true)
  | assert_eq(is_rule_enabled(config, "MD003"), true)
  | assert_eq(is_rule_enabled(config, "MD004"), true)
end

def test_get_rule_config():
  let config = default_config()
  | let md002_config = get_rule_config(config, "md002")
  | assert_eq(md002_config["level"], 1)
  | let md026_config = get_rule_config(config, "md026")
  | assert_eq(md026_config["punctuation"], ".,;:!?")
end

def test_custom_config_md026():
  let config = {
    lint: {
      rules: ["MD026"],
      md026: {punctuation: ".!"}
    }
  }
  | let content = to_markdown("# Header with comma,\n")
  | let result = md026(content, config)
  | assert_eq(len(result), 0)
  | let content2 = to_markdown("# Header with period.\n")
  | let result2 = md026(content2, config)
  | assert_eq(len(result2), 1)
end

def test_lint_all_with_disabled_rules():
  let config = {
    lint: {
      rules: ["MD002"],
      md002: {level: 1},
      md024: {"siblings-only": false},
      md025: {level: 1},
      md026: {punctuation: ".,;:!?"},
      md033: {"allowed-elements": []},
      md040: {enabled: true}
    }
  }
  | let content = "## Not H1\n\n### Skipped Level\n"
  | let result = lint_all_with_config(content, config)
  | let total = result["summary"]["total"]
  | assert_eq(total, 1)
end

run_tests([
  test_case("MD001: Valid heading progression", test_md001_valid_heading_progression),
  test_case("MD001: Invalid heading skip", test_md001_invalid_heading_skip),
  test_case("MD002: Valid first header", test_md002_valid_first_header),
  test_case("MD002: Invalid first header", test_md002_invalid_first_header),
  test_case("MD003: Consistent ATX style", test_md003_consistent_atx_style),
  test_case("MD003: Inconsistent styles", test_md003_inconsistent_styles),
  test_case("MD003: Enforce ATX style", test_md003_enforce_atx_style),
  test_case("MD003: Enforce ATX closed style", test_md003_enforce_atx_closed_style),
  test_case("MD003: Consistent setext style", test_md003_consistent_setext_style),
  test_case("MD003: Enforce setext style", test_md003_enforce_setext_style),
  test_case("MD003: Mixed ATX and setext", test_md003_mixed_atx_and_setext),
  test_case("MD003: Setext H1 only", test_md003_setext_h1_only),
  test_case("MD003: Setext H2 only", test_md003_setext_h2_only),
  test_case("MD004: Consistent dash style", test_md004_consistent_dash_style),
  test_case("MD004: Consistent asterisk style", test_md004_consistent_asterisk_style),
  test_case("MD004: Consistent plus style", test_md004_consistent_plus_style),
  test_case("MD004: Inconsistent styles", test_md004_inconsistent_styles),
  test_case("MD004: Enforce dash style", test_md004_enforce_dash_style),
  test_case("MD004: Enforce asterisk style", test_md004_enforce_asterisk_style),
  test_case("MD004: Enforce plus style", test_md004_enforce_plus_style),
  test_case("MD024: No duplicate headers", test_md024_no_duplicate_headers),
  test_case("MD024: Duplicate headers", test_md024_duplicate_headers),
  test_case("MD025: Single H1", test_md025_single_h1),
  test_case("MD025: Multiple H1", test_md025_multiple_h1),
  test_case("MD026: No trailing punctuation", test_md026_no_trailing_punctuation),
  test_case("MD026: Trailing period", test_md026_trailing_period),
  test_case("MD026: Trailing question mark", test_md026_trailing_question),
  test_case("MD033: No HTML", test_md033_no_html),
  test_case("MD033: Inline HTML", test_md033_inline_html),
  test_case("MD040: Code with language", test_md040_code_with_language),
  test_case("MD040: Code without language", test_md040_code_without_language),
  test_case("Helper: format_issue", test_format_issue),
  test_case("Helper: count_by_severity", test_count_by_severity),
  test_case("Integration: lint_all clean document", test_lint_all_clean_document),
  test_case("Integration: lint_all with issues", test_lint_all_with_issues),
  test_case("Report: generate_report no issues", test_generate_report_no_issues),
  test_case("Report: generate_report with issues", test_generate_report_with_issues),
  test_case("Config: default_config", test_default_config),
  test_case("Config: is_rule_enabled", test_is_rule_enabled),
  test_case("Config: get_rule_config", test_get_rule_config),
  test_case("Config: custom config MD026", test_custom_config_md026),
  test_case("Config: lint_all with disabled rules", test_lint_all_with_disabled_rules)
])
