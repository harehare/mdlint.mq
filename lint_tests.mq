include "lint"
| include "test"

# Test data for MD001 - Heading levels should only increment by one level at a time
def test_md001_valid_heading_progression():
  let content = to_markdown("# H1\n## H2\n### H3\n")
  | let result = md001(content)
  | assert_eq(len(result), 0)
end

def test_md001_invalid_heading_skip():
  let content = to_markdown("# H1\n### H3 (skipped H2)\n")
  | let result = md001(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD001")
  | assert_eq(result[0]["severity"], "error")
end

# Test data for MD002 - First header should be a top level header
def test_md002_valid_first_header():
  let content = to_markdown("# First Header\n## Second Header\n")
  | let result = md002(content)
  | assert_eq(len(result), 0)
end

def test_md002_invalid_first_header():
  let content = to_markdown("## Not H1\n### Another Header\n")
  | let result = md002(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD002")
  | assert_eq(result[0]["severity"], "error")
end

# Test data for MD024 - Multiple headers with the same content
def test_md024_no_duplicate_headers():
  let content = to_markdown("# Header 1\n## Header 2\n### Header 3\n")
  | let result = md024(content)
  | assert_eq(len(result), 0)
end

def test_md024_duplicate_headers():
  let content = to_markdown("# Test\n## Test\n")
  | let result = md024(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD024")
  | assert_eq(result[0]["severity"], "warning")
end

# Test data for MD025 - Multiple top level headers
def test_md025_single_h1():
  let content = to_markdown("# Only One H1\n## H2\n### H3\n")
  | let result = md025(content)
  | assert_eq(len(result), 0)
end

def test_md025_multiple_h1():
  let content = to_markdown("# First H1\n## H2\n# Second H1\n")
  | let result = md025(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD025")
  | assert_eq(result[0]["severity"], "error")
end

# Test data for MD026 - Trailing punctuation in header
def test_md026_no_trailing_punctuation():
  let content = to_markdown("# Clean Header\n## Another Clean Header\n")
  | let result = md026(content)
  | assert_eq(len(result), 0)
end

def test_md026_trailing_period():
  let content = to_markdown("# Header with period.\n")
  | let result = md026(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD026")
  | assert_eq(result[0]["severity"], "warning")
end

def test_md026_trailing_question():
  let content = to_markdown("# Header with question?\n")
  | let result = md026(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD026")
end

# Test data for MD033 - Inline HTML
def test_md033_no_html():
  let content = to_markdown("# Header\n\nJust plain text.\n")
  | let result = md033(content)
  | assert_eq(len(result), 0)
end

def test_md033_inline_html():
  let content = to_markdown("# Header\n\n<div>Some HTML</div>\n")
  | let result = md033(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD033")
  | assert_eq(result[0]["severity"], "warning")
end

# Test data for MD040 - Fenced code blocks should have a language
def test_md040_code_with_language():
  let content = to_markdown("# Header\n\n```javascript\nconsole.log('test');\n```\n")
  | let result = md040(content)
  | assert_eq(len(result), 0)
end

def test_md040_code_without_language():
  let content = to_markdown("# Header\n\n```\ncode without language\n```\n")
  | let result = md040(content)
  | assert_eq(len(result), 1)
  | assert_eq(result[0]["rule"], "MD040")
  | assert_eq(result[0]["severity"], "warning")
end

# Test helper functions
def test_format_issue():
  let issue = {
    rule: "MD001",
    name: "heading-increment",
    severity: "error",
    message: "Test message",
    line: 5
  }
  | let formatted = format_issue(issue)
  | assert_eq(contains(formatted, "MD001"), true)
  | assert_eq(contains(formatted, "heading-increment"), true)
  | assert_eq(contains(formatted, "Test message"), true)
end

def test_count_by_severity():
  let issues = [
    {severity: "error"},
    {severity: "error"},
    {severity: "warning"},
    {severity: "info"}
  ]
  | let counts = count_by_severity(issues)
  | assert_eq(counts["errors"], 2)
  | assert_eq(counts["warnings"], 1)
  | assert_eq(counts["info"], 1)
  | assert_eq(counts["total"], 4)
end

# Integration test with lint_all
def test_lint_all_clean_document():
  let content = to_markdown("# Title\n\n## Section\n\nContent here.\n")
  | let result = lint_all(content)
  | assert_eq(result["summary"]["errors"], 0)
end

def test_lint_all_with_issues():
  let content = to_markdown("## Not H1\n\n### Skipped Level\n\n# Duplicate\n\n# Duplicate\n")
  | let result = lint_all(content)
  | let total = result["summary"]["total"]
  | assert_eq(total > 0, true)
end

# Test generate_report function
def test_generate_report_no_issues():
  let lint_result = {
    issues: [],
    summary: {errors: 0, warnings: 0, info: 0, total: 0}
  }
  | let report = generate_report(lint_result)
  | assert_eq(contains(report, "No issues found"), true)
end

def test_generate_report_with_issues():
  let issue = {
    rule: "MD001",
    name: "heading-increment",
    severity: "error",
    message: "Test issue",
    line: 1
  }
  | let lint_result = {
    issues: [issue],
    summary: {errors: 1, warnings: 0, info: 0, total: 1}
  }
  | let report = generate_report(lint_result)
  | assert_eq(contains(report, "Markdown Lint Report"), true)
  | assert_eq(contains(report, "Found 1 issues"), true)
end

run_tests([
  test_case("MD001: Valid heading progression", test_md001_valid_heading_progression),
  test_case("MD001: Invalid heading skip", test_md001_invalid_heading_skip),
  test_case("MD002: Valid first header", test_md002_valid_first_header),
  test_case("MD002: Invalid first header", test_md002_invalid_first_header),
  test_case("MD024: No duplicate headers", test_md024_no_duplicate_headers),
  test_case("MD024: Duplicate headers", test_md024_duplicate_headers),
  test_case("MD025: Single H1", test_md025_single_h1),
  test_case("MD025: Multiple H1", test_md025_multiple_h1),
  test_case("MD026: No trailing punctuation", test_md026_no_trailing_punctuation),
  test_case("MD026: Trailing period", test_md026_trailing_period),
  test_case("MD026: Trailing question mark", test_md026_trailing_question),
  test_case("MD033: No HTML", test_md033_no_html),
  test_case("MD033: Inline HTML", test_md033_inline_html),
  test_case("MD040: Code with language", test_md040_code_with_language),
  test_case("MD040: Code without language", test_md040_code_without_language),
  test_case("Helper: format_issue", test_format_issue),
  test_case("Helper: count_by_severity", test_count_by_severity),
  test_case("Integration: lint_all clean document", test_lint_all_clean_document),
  test_case("Integration: lint_all with issues", test_lint_all_with_issues),
  test_case("Report: generate_report no issues", test_generate_report_no_issues),
  test_case("Report: generate_report with issues", test_generate_report_with_issues)
])
