#!/usr/bin/env bash
# mqlint - Markdown linter using lint.mq
#
# Usage:
#   mqlint [file.md]              Lint a specific file
#   mqlint                        Lint all .md files in current directory
#   mqlint -h, --help             Show help message

set -euo pipefail

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
mqlint - Markdown linter using lint.mq

Usage:
  mqlint [OPTIONS] [FILE...]

Options:
  -h, --help              Show this help message
  -v, --version           Show version
  -c, --config FILE       Use custom config file (default: .lintrc.toml)
  -q, --quiet             Quiet mode (suppress info messages)
  -j, --json              Output results in JSON format

Arguments:
  FILE                    Markdown file(s) to lint (default: all .md files)

Examples:
  mqlint README.md        Lint README.md
  mqlint *.md             Lint all .md files
  mqlint                  Lint all .md files in current directory
  mqlint -c custom.toml   Use custom config file
  mqlint -j README.md     Output in JSON format

EOF
}

show_version() {
    echo "mqlint version $VERSION"
}

# Default values
CONFIG_FILE=".lintrc.toml"
QUIET=false
JSON_OUTPUT=false
FILES=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -c|--config)
            CONFIG_FILE="$2"
            shift 2
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        -j|--json)
            JSON_OUTPUT=true
            shift
            ;;
        -*)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
        *)
            FILES+=("$1")
            shift
            ;;
    esac
done

# If no files specified, find all .md files
if [ ${#FILES[@]} -eq 0 ]; then
    mapfile -t FILES < <(find . -maxdepth 1 -name "*.md" -type f)
    if [ ${#FILES[@]} -eq 0 ]; then
        echo -e "${YELLOW}No Markdown files found in current directory${NC}"
        exit 0
    fi
fi

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    if [ "$CONFIG_FILE" != ".lintrc.toml" ]; then
        echo -e "${RED}Error: Config file '$CONFIG_FILE' not found${NC}"
        exit 1
    fi
    # Use default config if .lintrc.toml doesn't exist
    CONFIG_LOAD="default_config()"
else
    CONFIG_LOAD="load_config(\"$CONFIG_FILE\") | merge_config()"
fi

# Lint each file
TOTAL_ERRORS=0
TOTAL_WARNINGS=0
LINTED_FILES=0

# JSON output: collect all results
if [ "$JSON_OUTPUT" = true ]; then
    JSON_RESULTS="["
    FIRST_FILE=true

    for file in "${FILES[@]}"; do
        if [ ! -f "$file" ]; then
            echo -e "${RED}Error: File '$file' not found${NC}" >&2
            continue
        fi

        # Escape the file path for use in mq command
        ESCAPED_FILE=$(printf '%s' "$file" | sed 's/["\\]/\\&/g')

        # Run linter with JSON output
        MQ_SCRIPT="include \"lint\" | let content = read_file(\"$ESCAPED_FILE\") | let config = $CONFIG_LOAD | lint_all_with_config(content, config) | generate_json_report()"

        if OUTPUT=$(mq -I raw -F json "$MQ_SCRIPT" 2>&1); then
            if [ "$FIRST_FILE" = false ]; then
                JSON_RESULTS+=","
            fi
            JSON_RESULTS+="{\"file\":\"$file\",\"result\":$OUTPUT}"
            FIRST_FILE=false
            LINTED_FILES=$((LINTED_FILES + 1))
        else
            echo -e "${RED}Error linting $file:${NC}" >&2
            echo "$OUTPUT" >&2
        fi
    done

    JSON_RESULTS+="]"
    echo "$JSON_RESULTS"
else
    # Text output (original behavior)
    for file in "${FILES[@]}"; do
        if [ ! -f "$file" ]; then
            echo -e "${RED}Error: File '$file' not found${NC}"
            continue
        fi

        if [ "$QUIET" = false ]; then
            echo -e "\n${GREEN}Linting:${NC} $file"
        fi

        # Escape the file path for use in mq command
        ESCAPED_FILE=$(printf '%s' "$file" | sed 's/["\\]/\\&/g')

        # Run linter
        MQ_SCRIPT="include \"lint\" | let content = read_file(\"$ESCAPED_FILE\") | let config = $CONFIG_LOAD | lint_all_with_config(content, config) | generate_report()"

        if OUTPUT=$(mq -I raw "$MQ_SCRIPT" 2>&1); then
            echo "$OUTPUT"
            LINTED_FILES=$((LINTED_FILES + 1))
        else
            echo -e "${RED}Error linting $file:${NC}"
            echo "$OUTPUT"
        fi
    done

    if [ "$QUIET" = false ]; then
        echo -e "\n${GREEN}Linted $LINTED_FILES file(s)${NC}"
    fi
fi

exit 0
